# âš™ï¸ PAIRLY BACKEND ARCHITECTURE

## ğŸ“Š Visual Mindmap

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚    PAIRLY BACKEND API            â”‚
                                    â”‚   FastAPI + MongoDB + Beanie     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                            â”‚                              â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   PUBLIC APIs    â”‚        â”‚  PROTECTED APIs  â”‚         â”‚   ADMIN APIs     â”‚
           â”‚  (No auth req'd) â”‚        â”‚  (JWT required)  â”‚         â”‚  (Admin only)    â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                           â”‚                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      â”‚     â”‚                     â”‚      â”‚                      â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”â”‚                     â”‚      â”‚                      â”‚
   â”‚  /auth/   â”‚      â”‚ /profiles/ â”‚â”‚                     â”‚      â”‚                      â”‚
   â”‚  signup   â”‚      â”‚   CRUD     â”‚â”‚                     â”‚      â”‚                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                     â”‚      â”‚                      â”‚
        â”‚                      â”‚     â”‚                     â”‚      â”‚                      â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”â”‚                     â”‚      â”‚                      â”‚
   â”‚  /auth/   â”‚      â”‚/discovery/ â”‚â”‚                     â”‚      â”‚                      â”‚
   â”‚   login   â”‚      â”‚  search    â”‚â”‚                     â”‚      â”‚                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                     â”‚      â”‚                      â”‚
        â”‚                      â”‚     â”‚                     â”‚      â”‚                      â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”â”‚                     â”‚      â”‚                      â”‚
   â”‚  /auth/   â”‚      â”‚ /messages/ â”‚â”‚                     â”‚      â”‚                      â”‚
   â”‚ login-2fa â”‚      â”‚  WebSocket â”‚â”‚                     â”‚      â”‚                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                     â”‚      â”‚                      â”‚
        â”‚                      â”‚     â”‚                     â”‚      â”‚                      â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”â”‚                     â”‚      â”‚                      â”‚
   â”‚  /auth/   â”‚      â”‚ /credits/  â”‚â”‚                     â”‚      â”‚                      â”‚
   â”‚  refresh  â”‚      â”‚ balance    â”‚â”‚                     â”‚      â”‚                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                     â”‚      â”‚                      â”‚
        â”‚                      â”‚     â”‚                     â”‚      â”‚                      â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”â”‚                     â”‚      â”‚                      â”‚
   â”‚  /auth/   â”‚      â”‚/payments/  â”‚â”‚                     â”‚      â”‚                      â”‚
   â”‚  logout   â”‚      â”‚ checkout   â”‚â”‚                     â”‚      â”‚                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                     â”‚      â”‚                      â”‚
                               â”‚     â”‚                     â”‚      â”‚                      â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”â”‚                     â”‚      â”‚                      â”‚
                       â”‚ /payouts/  â”‚â”‚                     â”‚      â”‚                      â”‚
                       â”‚  request   â”‚â”‚                     â”‚      â”‚                      â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                     â”‚      â”‚                      â”‚
                               â”‚     â”‚                     â”‚      â”‚                      â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”â”‚                     â”‚      â”‚                      â”‚
                       â”‚  /media/   â”‚â”‚                     â”‚      â”‚                      â”‚
                       â”‚  upload    â”‚â”‚                     â”‚      â”‚                      â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                     â”‚      â”‚                      â”‚
                               â”‚     â”‚                     â”‚      â”‚                      â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”â”‚                     â”‚      â”‚                      â”‚
                       â”‚  /twofa/   â”‚â”‚                     â”‚      â”‚                      â”‚
                       â”‚  enable    â”‚â”‚                     â”‚      â”‚                      â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                     â”‚      â”‚                      â”‚
                                     â”‚                     â”‚      â”‚                      â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚                      â”‚
                                                                  â”‚                      â”‚
                                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚   ADMIN ROUTES      â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚                    â”‚                     â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  /admin/users   â”‚  â”‚ /admin/security â”‚  â”‚/admin/analytics â”‚
                         â”‚   management    â”‚  â”‚  fraud alerts   â”‚  â”‚  platform stats â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚                    â”‚                     â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  suspend user   â”‚  â”‚  ban IP         â”‚  â”‚  revenue data   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ Database Architecture (MongoDB + Beanie)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MONGODB COLLECTIONS                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                 â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚  USERS   â”‚                    â”‚  PROFILES   â”‚
   â”‚ Collectionâ”‚                    â”‚ Collection  â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                 â”‚
        â”‚  â€¢ id (PK)                      â”‚  â€¢ user_id (FK)
        â”‚  â€¢ email                        â”‚  â€¢ display_name
        â”‚  â€¢ password_hash                â”‚  â€¢ bio
        â”‚  â€¢ name                         â”‚  â€¢ age
        â”‚  â€¢ role                         â”‚  â€¢ price_per_message
        â”‚  â€¢ credits_balance              â”‚  â€¢ location (GeoJSON)
        â”‚  â€¢ is_suspended                 â”‚  â€¢ profile_picture_url
        â”‚  â€¢ twofa_enabled                â”‚  â€¢ gallery_urls []
        â”‚  â€¢ twofa_method                 â”‚  â€¢ is_online
        â”‚  â€¢ twofa_secret                 â”‚  â€¢ total_earnings
        â”‚  â€¢ created_at                   â”‚  â€¢ view_count
        â”‚  â€¢ updated_at                   â”‚  â€¢ created_at
        â”‚                                 â”‚  â€¢ updated_at
        â”‚                                 â”‚
        â”‚                                 â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚ SESSIONS â”‚                    â”‚  MESSAGES   â”‚
   â”‚Collectionâ”‚                    â”‚ Collection  â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                 â”‚
        â”‚  â€¢ user_id (FK)                 â”‚  â€¢ sender_id (FK)
        â”‚  â€¢ ip_address                   â”‚  â€¢ recipient_id (FK)
        â”‚  â€¢ fingerprint_hash             â”‚  â€¢ content
        â”‚  â€¢ refresh_token_id             â”‚  â€¢ sent_at
        â”‚  â€¢ revoked                      â”‚  â€¢ read_at
        â”‚  â€¢ expires_at                   â”‚  â€¢ credits_charged
        â”‚  â€¢ created_at                   â”‚
        â”‚                                 â”‚
        â”‚                                 â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ DEVICE_          â”‚            â”‚  CREDITS_           â”‚
   â”‚ FINGERPRINTS     â”‚            â”‚  TRANSACTIONS       â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                 â”‚
        â”‚  â€¢ fingerprint_hash (PK)        â”‚  â€¢ user_id (FK)
        â”‚  â€¢ user_id (FK)                 â”‚  â€¢ amount
        â”‚  â€¢ ip_address                   â”‚  â€¢ transaction_type
        â”‚  â€¢ user_agent                   â”‚  â€¢ balance_after
        â”‚  â€¢ risk_score                   â”‚  â€¢ description
        â”‚  â€¢ risk_history []              â”‚  â€¢ metadata
        â”‚  â€¢ trusted                      â”‚  â€¢ created_at
        â”‚  â€¢ created_at                   â”‚
        â”‚                                 â”‚
        â”‚                                 â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚ FRAUD_ALERTS â”‚                â”‚  PAYOUTS    â”‚
   â”‚  Collection  â”‚                â”‚ Collection  â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                 â”‚
        â”‚  â€¢ user_id (FK)                 â”‚  â€¢ creator_id (FK)
        â”‚  â€¢ fingerprint_hash             â”‚  â€¢ amount_credits
        â”‚  â€¢ risk_score                   â”‚  â€¢ amount_usd
        â”‚  â€¢ rule_triggered               â”‚  â€¢ status
        â”‚  â€¢ status                       â”‚  â€¢ payment_method
        â”‚  â€¢ metadata                     â”‚  â€¢ payment_details
        â”‚  â€¢ created_at                   â”‚  â€¢ admin_notes
        â”‚                                 â”‚  â€¢ approved_by (FK)
        â”‚                                 â”‚  â€¢ approved_at
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚  â€¢ completed_at
   â”‚ FAILED_LOGINSâ”‚                      â”‚  â€¢ created_at
   â”‚  Collection  â”‚                      â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
        â”‚                                 â”‚
        â”‚  â€¢ email                        â”‚
        â”‚  â€¢ ip_address                   â”‚
        â”‚  â€¢ count                        â”‚
        â”‚  â€¢ locked_until                 â”‚
        â”‚  â€¢ created_at                   â”‚
        â”‚                                 â”‚
        â”‚                                 â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚  AUDIT_LOGS  â”‚                â”‚     OTP     â”‚
   â”‚  Collection  â”‚                â”‚ Collection  â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                 â”‚
        â”‚  â€¢ actor_user_id (FK)           â”‚  â€¢ user_id (FK)
        â”‚  â€¢ actor_ip                     â”‚  â€¢ code
        â”‚  â€¢ action                       â”‚  â€¢ type (email/totp)
        â”‚  â€¢ details                      â”‚  â€¢ used
        â”‚  â€¢ severity                     â”‚  â€¢ expires_at
        â”‚  â€¢ created_at                   â”‚  â€¢ attempts
        â”‚                                 â”‚  â€¢ created_at
        â”‚                                 â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
   â”‚ NOTIFICATIONS â”‚                     â”‚
   â”‚  Collection   â”‚                     â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
        â”‚                                 â”‚
        â”‚  â€¢ user_id (FK)                 â”‚
        â”‚  â€¢ type                         â”‚
        â”‚  â€¢ title                        â”‚
        â”‚  â€¢ message                      â”‚
        â”‚  â€¢ read                         â”‚
        â”‚  â€¢ created_at                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ Services Layer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  BUSINESS LOGIC SERVICES               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  1. Token Service (token_utils.py)                    â”‚
â”‚     â”œâ”€â”€ create_access_token()                         â”‚
â”‚     â”œâ”€â”€ create_refresh_token()                        â”‚
â”‚     â”œâ”€â”€ verify_token()                                â”‚
â”‚     â””â”€â”€ decode_token()                                â”‚
â”‚                                                        â”‚
â”‚  2. 2FA Service (twofa.py)                            â”‚
â”‚     â”œâ”€â”€ generate_totp_secret()                        â”‚
â”‚     â”œâ”€â”€ verify_totp()                                 â”‚
â”‚     â”œâ”€â”€ send_email_otp()                              â”‚
â”‚     â”œâ”€â”€ verify_email_otp()                            â”‚
â”‚     â”œâ”€â”€ check_otp_attempts()                          â”‚
â”‚     â””â”€â”€ clear_otp_attempts()                          â”‚
â”‚                                                        â”‚
â”‚  3. Fingerprint Service (fingerprint.py)              â”‚
â”‚     â”œâ”€â”€ register_fingerprint()                        â”‚
â”‚     â”œâ”€â”€ calculate_risk_score()                        â”‚
â”‚     â”œâ”€â”€ check_suspicious()                            â”‚
â”‚     â””â”€â”€ update_trust_level()                          â”‚
â”‚                                                        â”‚
â”‚  4. Risk Scoring Service (risk.py)                    â”‚
â”‚     â”œâ”€â”€ evaluate_risk()                               â”‚
â”‚     â”œâ”€â”€ check_rules()                                 â”‚
â”‚     â”œâ”€â”€ detect_anomalies()                            â”‚
â”‚     â””â”€â”€ flag_fraud()                                  â”‚
â”‚                                                        â”‚
â”‚  5. Audit Service (audit.py)                          â”‚
â”‚     â”œâ”€â”€ log_event()                                   â”‚
â”‚     â”œâ”€â”€ log_security_event()                          â”‚
â”‚     â””â”€â”€ get_audit_trail()                             â”‚
â”‚                                                        â”‚
â”‚  6. Presence Service (presence.py)                    â”‚
â”‚     â”œâ”€â”€ update_online_status()                        â”‚
â”‚     â”œâ”€â”€ start_presence_monitor()                      â”‚
â”‚     â””â”€â”€ get_online_users()                            â”‚
â”‚                                                        â”‚
â”‚  7. WebSocket Rate Limiter (ws_rate_limiter.py)       â”‚
â”‚     â”œâ”€â”€ WSRateLimiter class                           â”‚
â”‚     â”œâ”€â”€ allow_message()                               â”‚
â”‚     â”œâ”€â”€ mute_user()                                   â”‚
â”‚     â””â”€â”€ is_muted()                                    â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›¡ï¸ Middleware Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        FASTAPI MIDDLEWARE STACK            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  1. CORS Middleware                        â”‚
â”‚     â€¢ Allow origins: *                     â”‚
â”‚     â€¢ Allow credentials: true              â”‚
â”‚     â€¢ Allow methods: all                   â”‚
â”‚     â€¢ Allow headers: all                   â”‚
â”‚        â”‚                                   â”‚
â”‚        â–¼                                   â”‚
â”‚  2. Rate Limiter Middleware                â”‚
â”‚     â€¢ 60 requests/minute per IP            â”‚
â”‚     â€¢ 150 req/min = ban                    â”‚
â”‚     â€¢ Ban duration: 3600s                  â”‚
â”‚     â€¢ In-memory tracking                   â”‚
â”‚        â”‚                                   â”‚
â”‚        â–¼                                   â”‚
â”‚  3. Request Logging                        â”‚
â”‚     â€¢ Log all incoming requests            â”‚
â”‚     â€¢ Track response times                 â”‚
â”‚        â”‚                                   â”‚
â”‚        â–¼                                   â”‚
â”‚  4. Error Handling                         â”‚
â”‚     â€¢ Global exception handler             â”‚
â”‚     â€¢ Formatted error responses            â”‚
â”‚        â”‚                                   â”‚
â”‚        â–¼                                   â”‚
â”‚  5. Routes Processing                      â”‚
â”‚     â€¢ Execute endpoint logic               â”‚
â”‚        â”‚                                   â”‚
â”‚        â–¼                                   â”‚
â”‚  6. Response                               â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Project Structure

```
backend/
â”œâ”€â”€ main.py                       # FastAPI app entry
â”œâ”€â”€ server.py                     # Compatibility wrapper
â”œâ”€â”€ config.py                     # Environment config
â”œâ”€â”€ database.py                   # MongoDB + Beanie init
â”œâ”€â”€ requirements.txt              # Dependencies
â”œâ”€â”€ .env                          # Environment variables
â”‚
â”œâ”€â”€ models/                       # Beanie ODM models
â”‚   â”œâ”€â”€ user.py
â”‚   â”œâ”€â”€ profile.py
â”‚   â”œâ”€â”€ session.py
â”‚   â”œâ”€â”€ device_fingerprint.py
â”‚   â”œâ”€â”€ fraud_alert.py
â”‚   â”œâ”€â”€ failed_login.py
â”‚   â”œâ”€â”€ audit_log.py
â”‚   â”œâ”€â”€ notification.py
â”‚   â”œâ”€â”€ otp.py
â”‚   â”œâ”€â”€ message.py
â”‚   â”œâ”€â”€ credits_transaction.py
â”‚   â””â”€â”€ payout.py
â”‚
â”œâ”€â”€ routes/                       # API endpoints
â”‚   â”œâ”€â”€ auth.py                   # Login/signup/2FA
â”‚   â”œâ”€â”€ twofa.py                  # 2FA management
â”‚   â”œâ”€â”€ profiles.py               # Profile CRUD
â”‚   â”œâ”€â”€ discovery.py              # Search/filter
â”‚   â”œâ”€â”€ messaging.py              # WebSocket chat
â”‚   â”œâ”€â”€ credits.py                # Balance/transactions
â”‚   â”œâ”€â”€ payments.py               # Stripe/Razorpay
â”‚   â”œâ”€â”€ payouts.py                # Creator payouts
â”‚   â”œâ”€â”€ media.py                  # S3 uploads
â”‚   â”œâ”€â”€ admin_security.py         # Admin security
â”‚   â””â”€â”€ admin_analytics.py        # Admin analytics
â”‚
â”œâ”€â”€ services/                     # Business logic
â”‚   â”œâ”€â”€ token_utils.py
â”‚   â”œâ”€â”€ twofa.py
â”‚   â”œâ”€â”€ fingerprint.py
â”‚   â”œâ”€â”€ risk.py
â”‚   â”œâ”€â”€ audit.py
â”‚   â”œâ”€â”€ presence.py
â”‚   â””â”€â”€ ws_rate_limiter.py
â”‚
â”œâ”€â”€ middleware/                   # Middleware
â”‚   â”œâ”€â”€ rate_limiter.py
â”‚   â””â”€â”€ failed_login.py
â”‚
â””â”€â”€ workers/                      # Background jobs
    â””â”€â”€ fraud_worker.py
```

---

## ğŸ” Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SIGNUP    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /auth/signupâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Validate data  â”‚
â”‚ â€¢ Hash password  â”‚
â”‚ â€¢ Create user    â”‚
â”‚ â€¢ Generate JWT   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return tokens    â”‚
â”‚ â€¢ access_token   â”‚
â”‚ â€¢ refresh_token  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    LOGIN    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /auth/login â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Verify email   â”‚
â”‚ â€¢ Check password â”‚
â”‚ â€¢ Device check   â”‚
â”‚ â€¢ Risk score     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚             â”‚
  2FA? â”‚             â”‚ No
   Yes â”‚             â”‚
       â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return       â”‚  â”‚ Return JWT   â”‚
â”‚ temp_token   â”‚  â”‚ â€¢ access     â”‚
â”‚ requires_2fa â”‚  â”‚ â€¢ refresh    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /auth/      â”‚
â”‚   login-2fa      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Verify code    â”‚
â”‚ â€¢ Check attempts â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return JWT       â”‚
â”‚ â€¢ access_token   â”‚
â”‚ â€¢ refresh_token  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TOKEN REFRESH  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /auth/      â”‚
â”‚   refresh        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Verify refresh â”‚
â”‚ â€¢ Check revoked  â”‚
â”‚ â€¢ Generate new   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return new JWT   â”‚
â”‚ â€¢ access_token   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¬ WebSocket Messaging Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENT CONNECT â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WS /messages/ws/{id}   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Accept Connection      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Receive Auth Token     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Verify JWT Token       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Store in Active        â”‚
â”‚ Connections Dict       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Send Confirmation      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚
    SEND â”‚              â”‚ RECEIVE
         â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rate Limit   â”‚  â”‚ Parse JSON   â”‚
â”‚ Check        â”‚  â”‚ Message      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚
       â–¼                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ Credit Check â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
       â”‚                 â”‚
       â–¼                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ Deduct       â”‚         â”‚
â”‚ Credits      â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
       â”‚                 â”‚
       â–¼                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ Save to DB   â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
       â”‚                 â”‚
       â–¼                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ Forward to   â”‚         â”‚
â”‚ Recipient WS â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
       â”‚                 â”‚
       â–¼                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ Send ACK     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’° Payment Flow (Stripe/Razorpay)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BUY CREDITS    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /payments/       â”‚
â”‚      checkout         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Select package      â”‚
â”‚ â€¢ Choose provider     â”‚
â”‚ â€¢ Risk check          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚
    Stripeâ”‚              â”‚ Razorpay
         â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create       â”‚  â”‚ Create       â”‚
â”‚ Stripe       â”‚  â”‚ Razorpay     â”‚
â”‚ Session      â”‚  â”‚ Order        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚
       â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return       â”‚  â”‚ Return       â”‚
â”‚ checkout_url â”‚  â”‚ checkout_url â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Redirect User to       â”‚
â”‚ Payment Gateway        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Completes Payment â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Webhook Callback       â”‚
â”‚ POST /payments/webhook â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Verify Signature       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Credit User Account    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Log Transaction        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Send Notification      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SECURITY LAYERS                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  Layer 1: Request Level                             â”‚
â”‚  â”œâ”€â”€ CORS validation                                â”‚
â”‚  â”œâ”€â”€ Rate limiting (60/min per IP)                  â”‚
â”‚  â”œâ”€â”€ IP banning (150+/min = ban)                    â”‚
â”‚  â””â”€â”€ Request size limits                            â”‚
â”‚                                                     â”‚
â”‚  Layer 2: Authentication                            â”‚
â”‚  â”œâ”€â”€ JWT token validation                           â”‚
â”‚  â”œâ”€â”€ Token expiry checks                            â”‚
â”‚  â”œâ”€â”€ Refresh token rotation                         â”‚
â”‚  â””â”€â”€ Device fingerprinting                          â”‚
â”‚                                                     â”‚
â”‚  Layer 3: Authorization                             â”‚
â”‚  â”œâ”€â”€ Role-based access (fan/creator/admin)         â”‚
â”‚  â”œâ”€â”€ Resource ownership checks                      â”‚
â”‚  â”œâ”€â”€ Permission validation                          â”‚
â”‚  â””â”€â”€ Admin privilege verification                   â”‚
â”‚                                                     â”‚
â”‚  Layer 4: 2FA                                       â”‚
â”‚  â”œâ”€â”€ TOTP (Time-based OTP)                          â”‚
â”‚  â”œâ”€â”€ Email OTP                                      â”‚
â”‚  â”œâ”€â”€ Attempt limiting                               â”‚
â”‚  â””â”€â”€ Device trust management                        â”‚
â”‚                                                     â”‚
â”‚  Layer 5: Fraud Detection                           â”‚
â”‚  â”œâ”€â”€ Risk scoring algorithm                         â”‚
â”‚  â”œâ”€â”€ Device fingerprint analysis                    â”‚
â”‚  â”œâ”€â”€ Behavioral anomaly detection                   â”‚
â”‚  â”œâ”€â”€ IP reputation checking                         â”‚
â”‚  â””â”€â”€ Pattern recognition                            â”‚
â”‚                                                     â”‚
â”‚  Layer 6: Audit & Monitoring                        â”‚
â”‚  â”œâ”€â”€ All actions logged                             â”‚
â”‚  â”œâ”€â”€ Security event tracking                        â”‚
â”‚  â”œâ”€â”€ Failed login tracking                          â”‚
â”‚  â””â”€â”€ Admin action logging                           â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ API Endpoints Summary

### **Public Endpoints (No Auth Required)**
```
POST   /api/auth/signup          # User registration
POST   /api/auth/login           # User login
POST   /api/auth/login-2fa       # 2FA verification
POST   /api/auth/refresh         # Token refresh
POST   /api/auth/logout          # User logout
GET    /api/                     # Health check
GET    /api/health               # Health status
```

### **Protected Endpoints (JWT Required)**
```
# Profiles
GET    /api/profiles/{user_id}          # Get profile
POST   /api/profiles                    # Create profile
PUT    /api/profiles/{user_id}          # Update profile
DELETE /api/profiles/{user_id}          # Delete profile

# Discovery
GET    /api/discover                    # Search creators
GET    /api/discover/nearby             # Geo search

# Messaging
WS     /api/messages/ws/{user_id}       # WebSocket chat
GET    /api/messages/history/{user_id}  # Message history
GET    /api/messages/conversations      # Conversation list

# Credits
GET    /api/credits/balance             # Get balance
GET    /api/credits/transactions        # Transaction history

# Payments
POST   /api/payments/checkout           # Create checkout
POST   /api/payments/webhook            # Payment webhook

# Payouts (Creators)
POST   /api/payouts/request             # Request payout
GET    /api/payouts/my-payouts          # Payout history

# Media
POST   /api/media/upload-profile-picture
POST   /api/media/upload-gallery
DELETE /api/media/gallery/{index}

# 2FA Management
POST   /api/twofa/enable-totp           # Enable TOTP
POST   /api/twofa/verify-setup          # Verify setup
POST   /api/twofa/disable               # Disable 2FA
```

### **Admin Endpoints (Admin Role Required)**
```
# User Management
GET    /api/admin/users                 # List all users
POST   /api/admin/users/{id}/suspend    # Suspend user
POST   /api/admin/users/{id}/unsuspend  # Unsuspend user

# Security
GET    /api/admin/security/fraud-alerts # Get fraud alerts
POST   /api/admin/security/alerts/{id}/resolve
GET    /api/admin/security/analytics    # Security analytics
POST   /api/admin/security/ban-ip       # Ban IP address
POST   /api/admin/security/unban-ip     # Unban IP

# Payouts
GET    /api/admin/payouts/pending       # Pending payouts
POST   /api/admin/payouts/review/{id}   # Approve/reject

# Analytics
GET    /api/admin/analytics              # Platform stats
```

---

## âš¡ Performance & Scalability

### **Optimizations Implemented**
- âœ… Async/await throughout
- âœ… Connection pooling (MongoDB Motor)
- âœ… In-memory rate limiting
- âœ… Efficient database queries
- âœ… Indexed collections
- âœ… WebSocket connection management

### **Production Recommendations**
- ğŸ”„ Add Redis for distributed caching
- ğŸ”„ Implement CDN for static assets
- ğŸ”„ Add load balancer
- ğŸ”„ Database replication
- ğŸ”„ Horizontal scaling
- ğŸ”„ Message queue (Celery/RabbitMQ)
- ğŸ”„ API gateway (Kong/Nginx)

---

## ğŸ“Š Monitoring & Logging

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      LOGGING STRATEGY               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  Application Logs:                  â”‚
â”‚  â€¢ Request/response logging         â”‚
â”‚  â€¢ Error stack traces               â”‚
â”‚  â€¢ Performance metrics              â”‚
â”‚                                     â”‚
â”‚  Security Logs:                     â”‚
â”‚  â€¢ Login attempts                   â”‚
â”‚  â€¢ Failed authentications           â”‚
â”‚  â€¢ Suspicious activities            â”‚
â”‚  â€¢ IP bans                          â”‚
â”‚                                     â”‚
â”‚  Audit Logs (Database):             â”‚
â”‚  â€¢ User actions                     â”‚
â”‚  â€¢ Admin operations                 â”‚
â”‚  â€¢ Data modifications               â”‚
â”‚  â€¢ Payment transactions             â”‚
â”‚                                     â”‚
â”‚  System Logs:                       â”‚
â”‚  â€¢ Server health                    â”‚
â”‚  â€¢ Database connections             â”‚
â”‚  â€¢ WebSocket connections            â”‚
â”‚  â€¢ Resource usage                   â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ Configuration Management

```python
# config.py - Environment Variables

MONGODB_URI          # MongoDB connection string
JWT_SECRET           # JWT signing secret
REDIS_URL            # Redis connection (optional)
S3_BUCKET            # AWS S3 bucket name
S3_REGION            # AWS region
AWS_ACCESS_KEY_ID    # AWS credentials
AWS_SECRET_ACCESS_KEY
STRIPE_SECRET_KEY    # Stripe API key
STRIPE_PUBLISHABLE_KEY
RAZORPAY_KEY_ID      # Razorpay credentials
RAZORPAY_KEY_SECRET
CORS_ORIGINS         # Allowed origins
```

---

## ğŸ¯ Technology Stack

- **Framework**: FastAPI 0.110.1
- **Database**: MongoDB 4.5.0 with Motor (async)
- **ODM**: Beanie 1.23.0+
- **Authentication**: PyJWT 2.10.1+
- **Password Hashing**: Bcrypt 4.1.3
- **Payments**: Stripe 7.0+, Razorpay 1.4+
- **File Storage**: Boto3 1.34+ (S3)
- **2FA**: PyOTP 2.9+, QRCode 7.4+
- **WebSockets**: WebSockets 12.0+
- **Validation**: Pydantic 2.6.4+
- **HTTP Client**: HTTPX 0.25+
- **Testing**: Pytest 8.0+
